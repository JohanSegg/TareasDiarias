# TAREA 2 
## Se actualizo la tabla MAE_TABLA_DET


```sql
  UPDATE MAE_TABLA_DET
  SET DES_DETALLE = 'TERAPIA FISICA', 
      VAL_TEXTO = 'TF'
  WHERE TIP_TABLA = 'CSOTIPEXA'
    AND DES_DETALLE = 'MUSCULOESQUELETICO';
```


## Agregamos el siguiente insert a la tabla 
```sql
INSERT INTO CLI_PRESTACION (COD_PRESTACION, COD_PRESTACION_SUP, DES_PRESTACION, COD_USUARIO_REG, NIV_PRESTACION)
VALUES (600101, NULL, 'MUSCULOESQUELETICO', 'ADMIN', 3);
```

# TAREA 3
Elaborar un Dashboard que indique las atenciones realizadas por empresa en un rango de fechas:
- Nro de: Contratos, Protocolos asignados, Trabajadores asignados, Trabajadores atendidos
- Por cada Prestación: Nro de atenciones, Tiempo promedio de atención, Tiempo mínimo, Tiempo máximo
- Nro de examenes realizados por Laboratorio 


### Nro de contratos
-- esto me da todos los contratos, protocolos por contrato, trabajdores por protocolo 
-- - aqui neceisto trabajdores atendidos

```sql
SELECT CLI_CONTRATO.*,
       CSO_PROTOCOLO.*,
       TRABAJADORES.NUM_TRABAJADORES
FROM CLI_CONTRATO
LEFT JOIN CSO_CTT_PROTOCOLO ON CLI_CONTRATO.ID_CONTRATO = CSO_CTT_PROTOCOLO.ID_CONTRATO
LEFT JOIN CSO_PROTOCOLO ON CSO_CTT_PROTOCOLO.ID_PROTOCOLO = CSO_PROTOCOLO.ID_PROTOCOLO
LEFT JOIN (
    SELECT ID_CONTRATO, ID_PROTOCOLO, COUNT(*) as NUM_TRABAJADORES
    FROM CSO_CTT_TRABAJADOR
    GROUP BY ID_CONTRATO, ID_PROTOCOLO
) as TRABAJADORES
ON CLI_CONTRATO.ID_CONTRATO = TRABAJADORES.ID_CONTRATO
   AND CSO_CTT_PROTOCOLO.ID_PROTOCOLO = TRABAJADORES.ID_PROTOCOLO;
```

### Nro decontratos
```sql
--Nro empresas, total contratos, promedio contratos por empresas
SELECT
    COUNT(DISTINCT COD_EMPRESA) AS Total_Empresas,
    COUNT(*) AS Total_Contratos,
    CAST(COUNT(*) AS FLOAT) / COUNT(DISTINCT COD_EMPRESA) AS Promedio_Contratos_Por_Empresa
FROM
    CLI_CONTRATO;
```
```sql
--Total protocolos, promedio por contrato
SELECT
    SUM(COUNT( CSO_CTT_PROTOCOLO.ID_PROTOCOLO)) OVER() AS TOTAL_PROTOCOLOS,
    SUM(COUNT(CSO_CTT_PROTOCOLO.ID_PROTOCOLO)) OVER() / COUNT(DISTINCT CLI_CONTRATO.ID_CONTRATO) AS PROMEDIO_PROTOCOLOS_POR_CONTRATO
FROM
    CLI_CONTRATO
        LEFT JOIN CSO_CTT_PROTOCOLO ON CLI_CONTRATO.ID_CONTRATO = CSO_CTT_PROTOCOLO.ID_CONTRATO
GROUP BY ROLLUP(CLI_CONTRATO.ID_CONTRATO)
HAVING GROUPING(CLI_CONTRATO.ID_CONTRATO) = 1;
```

### Atendidos por protocolo
```sql
--ATENDIDOS POR PROTOCOLO
  SELECT
      P.ID_PROTOCOLO,
      COUNT(DISTINCT RE.ID_PERSONA_TRA) AS TotalAsignados,
      SUM(
              CASE WHEN
                      ((RE.IND_EVA_OFTALMOLOGICA = 'S' AND OFT.IND_ESTADO = 'A') OR  RE.IND_EVA_OFTALMOLOGICA = 'N')
                          AND ((RE.IND_EVA_ESPIROMETRIA = 'S' AND ESP.IND_ESTADO = 'A') OR  RE.IND_EVA_ESPIROMETRIA = 'N')
                          AND ((RE.IND_EVA_AUDIOMETRIA = 'S' AND AUD.IND_ESTADO = 'A')OR  RE.IND_EVA_AUDIOMETRIA = 'N')
                          AND ((RE.IND_EVA_CARDIOVASCULAR = 'S' AND CAR.IND_ESTADO = 'A')OR  RE.IND_EVA_CARDIOVASCULAR = 'N')
                          AND ((RE.IND_EVA_RADIOLOGICA = 'S' AND RAD.IND_ESTADO = 'A')OR  RE.IND_EVA_RADIOLOGICA = 'N')
                          AND ((RE.IND_EVA_PSICOLOGICA = 'S' AND PSI.IND_ESTADO = 'A')OR  RE.IND_EVA_PSICOLOGICA = 'N')
                          AND ((RE.IND_EXA_LABORATORIO = 'S' AND LAB.IND_ESTADO = 'A')OR  RE.IND_EXA_LABORATORIO = 'N')
                          AND ( EM.IND_ESTADO = 'A')

              THEN 1 ELSE 0 END
      ) AS TotalAtendidos
  FROM
      CSO_REGISTRO_EVALUACION RE
          INNER JOIN MAE_PERSONA PER ON RE.ID_PERSONA_TRA = PER.ID_PERSONA
          LEFT JOIN CSO_CTT_TRABAJADOR CTT ON CTT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO AND CTT.ID_PERSONA_TRA = RE.ID_PERSONA_TRA
          LEFT JOIN CSO_PROTOCOLO P ON CTT.ID_PROTOCOLO = P.ID_PROTOCOLO
          LEFT JOIN CSO_TRA_EVAL_MEDICA EM ON EM.ID_PERSONA_TRA = RE.ID_PERSONA_TRA AND EM.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_OFTALMO OFT ON OFT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_ESPIROMETRIA ESP ON ESP.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_AUDIOMETRIA AUD ON AUD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_CARDIOLOGIA CAR ON CAR.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_RADIOLOGICA RAD ON RAD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_PSICOLOGICA PSI ON PSI.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
          LEFT JOIN CSO_TRA_EVAL_LABORATORIO LAB ON LAB.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
  WHERE
      TIP_PERSONA = 'N'
  GROUP BY
      P.ID_PROTOCOLO;
```
### Atendidos por protocolo y fechas
```sql
--PERSONAS PROTOCOLOS POR FECHAS
SELECT
    P.ID_PROTOCOLO,
    COUNT(DISTINCT RE.ID_PERSONA_TRA) AS TotalAsignados, -- Este permanece como total general
    FORMAT(RE.FEC_EVALUACION, 'MMMM') AS Mes, -- Agrupación por mes (enero, febrero, etc.)
    SUM(
            CASE WHEN
                     ((RE.IND_EVA_OFTALMOLOGICA = 'S' AND OFT.IND_ESTADO = 'A') OR  RE.IND_EVA_OFTALMOLOGICA = 'N')
                         AND ((RE.IND_EVA_ESPIROMETRIA = 'S' AND ESP.IND_ESTADO = 'A') OR  RE.IND_EVA_ESPIROMETRIA = 'N')
                         AND ((RE.IND_EVA_AUDIOMETRIA = 'S' AND AUD.IND_ESTADO = 'A') OR  RE.IND_EVA_AUDIOMETRIA = 'N')
                         AND ((RE.IND_EVA_CARDIOVASCULAR = 'S' AND CAR.IND_ESTADO = 'A') OR  RE.IND_EVA_CARDIOVASCULAR = 'N')
                         AND ((RE.IND_EVA_RADIOLOGICA = 'S' AND RAD.IND_ESTADO = 'A') OR  RE.IND_EVA_RADIOLOGICA = 'N')
                         AND ((RE.IND_EVA_PSICOLOGICA = 'S' AND PSI.IND_ESTADO = 'A') OR  RE.IND_EVA_PSICOLOGICA = 'N')
                         AND ((RE.IND_EXA_LABORATORIO = 'S' AND LAB.IND_ESTADO = 'A') OR  RE.IND_EXA_LABORATORIO = 'N')
                         AND (EM.IND_ESTADO = 'A')

                     THEN 1 ELSE 0 END
    ) AS TotalAtendidos
FROM
    CSO_REGISTRO_EVALUACION RE
        INNER JOIN MAE_PERSONA PER ON RE.ID_PERSONA_TRA = PER.ID_PERSONA
        LEFT JOIN CSO_CTT_TRABAJADOR CTT ON CTT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO AND CTT.ID_PERSONA_TRA = RE.ID_PERSONA_TRA
        LEFT JOIN CSO_PROTOCOLO P ON CTT.ID_PROTOCOLO = P.ID_PROTOCOLO
        LEFT JOIN CSO_TRA_EVAL_MEDICA EM ON EM.ID_PERSONA_TRA = RE.ID_PERSONA_TRA AND EM.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_OFTALMO OFT ON OFT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_ESPIROMETRIA ESP ON ESP.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_AUDIOMETRIA AUD ON AUD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_CARDIOLOGIA CAR ON CAR.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_RADIOLOGICA RAD ON RAD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_PSICOLOGICA PSI ON PSI.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
        LEFT JOIN CSO_TRA_EVAL_LABORATORIO LAB ON LAB.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE
    TIP_PERSONA = 'N'
  AND RE.FEC_EVALUACION BETWEEN '2024-01-01' AND '2024-12-31' -- Filtro de rango de fechas
GROUP BY
    P.ID_PROTOCOLO,
    FORMAT(RE.FEC_EVALUACION, 'MMMM'); -- Agrupación por protocolo y mes

```
### Atendidos por protoclo y fechas mejorado

```sql
SELECT
    P.ID_PROTOCOLO,
    COUNT(DISTINCT RE.ID_PERSONA_TRA) AS TotalAsignados, -- Este permanece como total general
    FORMAT(RE.FEC_EVALUACION, 'MMMM yyyy') AS MesAnio, -- Agrupación por mes y año (ejemplo: November 2024)
    SUM(
        CASE WHEN
                 ((RE.IND_EVA_OFTALMOLOGICA = 'S' AND OFT.IND_ESTADO = 'A') OR  RE.IND_EVA_OFTALMOLOGICA = 'N')
                 AND ((RE.IND_EVA_ESPIROMETRIA = 'S' AND ESP.IND_ESTADO = 'A') OR  RE.IND_EVA_ESPIROMETRIA = 'N')
                 AND ((RE.IND_EVA_AUDIOMETRIA = 'S' AND AUD.IND_ESTADO = 'A') OR  RE.IND_EVA_AUDIOMETRIA = 'N')
                 AND ((RE.IND_EVA_CARDIOVASCULAR = 'S' AND CAR.IND_ESTADO = 'A') OR  RE.IND_EVA_CARDIOVASCULAR = 'N')
                 AND ((RE.IND_EVA_RADIOLOGICA = 'S' AND RAD.IND_ESTADO = 'A') OR  RE.IND_EVA_RADIOLOGICA = 'N')
                 AND ((RE.IND_EVA_PSICOLOGICA = 'S' AND PSI.IND_ESTADO = 'A') OR  RE.IND_EVA_PSICOLOGICA = 'N')
                 AND ((RE.IND_EXA_LABORATORIO = 'S' AND LAB.IND_ESTADO = 'A') OR  RE.IND_EXA_LABORATORIO = 'N')
                 AND (EM.IND_ESTADO = 'A')

             THEN 1 ELSE 0 END
    ) AS TotalAtendidos
FROM
    CSO_REGISTRO_EVALUACION RE
    INNER JOIN MAE_PERSONA PER ON RE.ID_PERSONA_TRA = PER.ID_PERSONA
    LEFT JOIN CSO_CTT_TRABAJADOR CTT ON CTT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO AND CTT.ID_PERSONA_TRA = RE.ID_PERSONA_TRA
    LEFT JOIN CSO_PROTOCOLO P ON CTT.ID_PROTOCOLO = P.ID_PROTOCOLO
    LEFT JOIN CSO_TRA_EVAL_MEDICA EM ON EM.ID_PERSONA_TRA = RE.ID_PERSONA_TRA AND EM.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_OFTALMO OFT ON OFT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_ESPIROMETRIA ESP ON ESP.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_AUDIOMETRIA AUD ON AUD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_CARDIOLOGIA CAR ON CAR.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_RADIOLOGICA RAD ON RAD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_PSICOLOGICA PSI ON PSI.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
    LEFT JOIN CSO_TRA_EVAL_LABORATORIO LAB ON LAB.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE
    TIP_PERSONA = 'N'
    AND RE.FEC_EVALUACION BETWEEN '2024-01-01' AND '2024-12-31' -- Filtro de rango de fechas
GROUP BY
    P.ID_PROTOCOLO,
    FORMAT(RE.FEC_EVALUACION, 'MMMM yyyy'); -- Agrupación por protocolo y mes con año

```
### Atendidos por prestacion

```sql
-- ATENDIDOS POR EVALUACIÓN
SELECT
    'MEDICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_OCUPACIONAL = 'S' AND EM.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_MEDICA EM ON EM.ID_PERSONA_TRA = RE.ID_PERSONA_TRA AND EM.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'OFTALMOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_OFTALMOLOGICA = 'S' AND OFT.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_OFTALMO OFT ON OFT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'ESPIROMETRIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_ESPIROMETRIA = 'S' AND ESP.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_ESPIROMETRIA ESP ON ESP.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'AUDIOMETRIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_AUDIOMETRIA = 'S' AND AUD.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_AUDIOMETRIA AUD ON AUD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'CARDIOLOGIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_CARDIOVASCULAR = 'S' AND CAR.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_CARDIOLOGIA CAR ON CAR.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'RADIOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_RADIOLOGICA = 'S' AND RAD.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_RADIOLOGICA RAD ON RAD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'PSICOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_PSICOLOGICA = 'S' AND PSI.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_PSICOLOGICA PSI ON PSI.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO

UNION ALL

SELECT
    'LABORATORIO' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EXA_LABORATORIO = 'S' AND LAB.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_LABORATORIO LAB ON LAB.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO;
```

### ATENDIDSO POR PRESTACION CON TIEMPO GENERAL
```sql
--Cn promedio de timepo
SELECT
    'MEDICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_OCUPACIONAL = 'S' AND EM.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, EM.HOR_INI_EVALUACION, EM.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_MEDICA EM ON EM.ID_PERSONA_TRA = RE.ID_PERSONA_TRA AND EM.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE EM.IND_ESTADO = 'A'

UNION ALL

SELECT
    'OFTALMOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_OFTALMOLOGICA = 'S' AND OFT.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, OFT.HOR_INI_EVALUACION, OFT.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_OFTALMO OFT ON OFT.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE OFT.IND_ESTADO = 'A'

UNION ALL

SELECT
    'ESPIROMETRIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_ESPIROMETRIA = 'S' AND ESP.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, ESP.HOR_INI_EVALUACION, ESP.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_ESPIROMETRIA ESP ON ESP.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE ESP.IND_ESTADO = 'A'

UNION ALL

SELECT
    'AUDIOMETRIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_AUDIOMETRIA = 'S' AND AUD.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, AUD.HOR_INI_EVALUACION, AUD.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_AUDIOMETRIA AUD ON AUD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE AUD.IND_ESTADO = 'A'

UNION ALL

SELECT
    'CARDIOLOGIA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_CARDIOVASCULAR = 'S' AND CAR.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, CAR.HOR_INI_EVALUACION, CAR.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_CARDIOLOGIA CAR ON CAR.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE CAR.IND_ESTADO = 'A'

UNION ALL

SELECT
    'RADIOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_RADIOLOGICA = 'S' AND RAD.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, RAD.HOR_INI_EVALUACION, RAD.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_RADIOLOGICA RAD ON RAD.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE RAD.IND_ESTADO = 'A'

UNION ALL

SELECT
    'PSICOLOGICA' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EVA_PSICOLOGICA = 'S' AND PSI.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, PSI.HOR_INI_EVALUACION, PSI.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_PSICOLOGICA PSI ON PSI.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE PSI.IND_ESTADO = 'A'

UNION ALL

SELECT
    'LABORATORIO' AS NombreEvaluacion,
    SUM(CASE WHEN RE.IND_EXA_LABORATORIO = 'S' AND LAB.IND_ESTADO = 'A' THEN 1 ELSE 0 END) AS TotalAtendidos,
    AVG(DATEDIFF(MINUTE, LAB.HOR_INI_EVALUACION, LAB.HOR_FIN_EVALUACION)) AS TiempoPromedioAtencion
FROM CSO_REGISTRO_EVALUACION RE
         LEFT JOIN CSO_TRA_EVAL_LABORATORIO LAB ON LAB.ID_REGISTRO_CSO = RE.ID_REGISTRO_CSO
WHERE LAB.IND_ESTADO = 'A';
```